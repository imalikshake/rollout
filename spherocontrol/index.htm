<html>

<head>
</head>

<body>
    <center>
        <canvas id="absoluteCvs" width="600" height="400" style="border:1px solid #000000;">
        </canvas>
        <canvas id="spheroAngleCvs" width="200" height="200" style="border:1px solid #000000;">
        </canvas>
        <canvas id="mycanvas" width="400" height="100"></canvas>
    </center>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="smoothie.js"></script>
    <script>
    var smoothie = new SmoothieChart();
    smoothie.streamTo(document.getElementById("mycanvas"));
    var sphero1 = new TimeSeries();
    var sphero2 = new TimeSeries();
    smoothie.addTimeSeries(sphero1);
    smoothie.addTimeSeries(sphero2);

    var socket = io();
    socket.on('data', function(msg) {
        for (var dtype in msg) {
            switch (dtype) {
                case 'ipData':
                    updateIpData(msg[dtype]);
                    break;
                case 'spheroData':
                    updateSpheroData(msg[dtype]);
                    break;
                default:
                    console.log('rip');
            }
        }
    });
    var canvas1 = document.getElementById('absoluteCvs');
    var ctx1 = canvas1.getContext('2d');
    var canvas2 = document.getElementById('spheroAngleCvs');
    var ctx2 = canvas2.getContext('2d');

    var spheroState = {
        abs: {},
        rel: {},
        drift: {}
    };

    function updateIpData(data) {
        if (!spheroState.abs[data.name])
            spheroState.abs[data.name] = {};
        if (!spheroState.drift[data.name])
            spheroState.drift[data.name] = {};

        spheroState.abs[data.name].x = data.pos.x;
        spheroState.abs[data.name].y = data.pos.y;

        spheroState.drift[data.name] = data.angle;
        sphero1.append(new Date().getTime(), data.angle);
    }

    function updateSpheroData(data) {
        if (!spheroState.rel[data.name])
            spheroState.rel[data.name] = {};
        var dx = spheroState.rel[data.name].x = data.data.dx;
        var dy = spheroState.rel[data.name].y = data.data.dy;

        // sphero1.append(new Date().getTime(), data.data.dx);
        sphero2.append(new Date().getTime(), Math.atan2(dy, dx));

    }

    function drawCircle(pos, r) {
        ctx1.beginPath();
        ctx1.arc(pos.x, pos.y, r, 0, 2 * Math.PI);
        ctx1.stroke();
    }

    function drawAbs(dt) {
        ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
        for (var sphAbs in spheroState.abs) {
            var sph = spheroState.abs[sphAbs];
            drawCircle(sph, 5);
        }
    }

    function drawRel(dt) {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        for (var name in spheroState.rel) {
            var sphdata = spheroState.rel[name];
            var angle = spheroState.drift[name];

            drawLine(ctx2,
                100,
                100,
                sphdata.x / 10 + 100,
                sphdata.y / 10 + 100
            );

            drawLine(ctx2,
                100,
                100,
                Math.cos(angle) * 250 + 100,
                Math.sin(angle) * 250 + 100,
                3
            );
        }
    }

    function draw(dt) {
        drawAbs(dt);
        drawRel(dt);
        requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    function drawLine(ctx, x1, y1, x2, y2, thickness) {
        ctx.lineWidth = thickness | 1;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }
    </script>
</body>

</html>
